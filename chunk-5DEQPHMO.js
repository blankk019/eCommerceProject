import{o as O}from"./chunk-BOADIA42.js";import{$ as V,A as S,B as u,C as l,Da as T,H as d,J as W,L as j,O as _,S as w,U as L,Y as m,a as k,ba as f,cc as K,d as A,ec as b,j as R,ka as x,m as M,n as I,o as N,r as c,ua as $,v as D,w as U,xa as B,y as P,z as F}from"./chunk-LPR7IXKC.js";var y="Service workers are disabled or not supported by this browser";function q(r){return U(()=>N(new Error(r)))}var g=class{constructor(t){if(this.serviceWorker=t,!t)this.worker=this.events=this.registration=q(y);else{let s=P(t,"controllerchange").pipe(c(()=>t.controller)),i=U(()=>I(t.controller)),o=D(i,s);this.worker=o.pipe(l(h=>!!h)),this.registration=this.worker.pipe(w(()=>t.getRegistration()));let v=P(t,"message").pipe(c(h=>h.data)).pipe(l(h=>h&&h.type)).pipe(_());v.connect(),this.events=v}}postMessage(t,e){return this.worker.pipe(d(1),L(s=>{s.postMessage(k({action:t},e))})).toPromise().then(()=>{})}postMessageWithOperation(t,e,s){let i=this.waitForOperationCompleted(s),o=this.postMessage(t,e);return Promise.all([o,i]).then(([,n])=>n)}generateNonce(){return Math.round(Math.random()*1e7)}eventsOfType(t){let e;return typeof t=="string"?e=s=>s.type===t:e=s=>t.includes(s.type),this.events.pipe(l(e))}nextEventOfType(t){return this.eventsOfType(t).pipe(d(1))}waitForOperationCompleted(t){return this.eventsOfType("OPERATION_COMPLETED").pipe(l(e=>e.nonce===t),d(1),c(e=>{if(e.result!==void 0)return e.result;throw new Error(e.error)})).toPromise()}get isEnabled(){return!!this.serviceWorker}},z=(()=>{class r{get isEnabled(){return this.sw.isEnabled}constructor(e){if(this.sw=e,this.pushManager=null,this.subscriptionChanges=new R,!e.isEnabled){this.messages=u,this.notificationClicks=u,this.subscription=u;return}this.messages=this.sw.eventsOfType("PUSH").pipe(c(i=>i.data)),this.notificationClicks=this.sw.eventsOfType("NOTIFICATION_CLICK").pipe(c(i=>i.data)),this.pushManager=this.sw.registration.pipe(c(i=>i.pushManager));let s=this.pushManager.pipe(w(i=>i.getSubscription()));this.subscription=S(s,this.subscriptionChanges)}requestSubscription(e){if(!this.sw.isEnabled||this.pushManager===null)return Promise.reject(new Error(y));let s={userVisibleOnly:!0},i=this.decodeBase64(e.serverPublicKey.replace(/_/g,"/").replace(/-/g,"+")),o=new Uint8Array(new ArrayBuffer(i.length));for(let n=0;n<i.length;n++)o[n]=i.charCodeAt(n);return s.applicationServerKey=o,this.pushManager.pipe(w(n=>n.subscribe(s)),d(1)).toPromise().then(n=>(this.subscriptionChanges.next(n),n))}unsubscribe(){if(!this.sw.isEnabled)return Promise.reject(new Error(y));let e=s=>{if(s===null)throw new Error("Not subscribed to push notifications.");return s.unsubscribe().then(i=>{if(!i)throw new Error("Unsubscribe failed!");this.subscriptionChanges.next(null)})};return this.subscription.pipe(d(1),w(e)).toPromise()}decodeBase64(e){return atob(e)}static{this.\u0275fac=function(s){return new(s||r)(f(g))}}static{this.\u0275prov=m({token:r,factory:r.\u0275fac})}}return r})(),C=(()=>{class r{get isEnabled(){return this.sw.isEnabled}constructor(e){if(this.sw=e,!e.isEnabled){this.versionUpdates=u,this.unrecoverable=u;return}this.versionUpdates=this.sw.eventsOfType(["VERSION_DETECTED","VERSION_INSTALLATION_FAILED","VERSION_READY","NO_NEW_VERSION_DETECTED"]),this.unrecoverable=this.sw.eventsOfType("UNRECOVERABLE_STATE")}checkForUpdate(){if(!this.sw.isEnabled)return Promise.reject(new Error(y));let e=this.sw.generateNonce();return this.sw.postMessageWithOperation("CHECK_FOR_UPDATES",{nonce:e},e)}activateUpdate(){if(!this.sw.isEnabled)return Promise.reject(new Error(y));let e=this.sw.generateNonce();return this.sw.postMessageWithOperation("ACTIVATE_UPDATE",{nonce:e},e)}static{this.\u0275fac=function(s){return new(s||r)(f(g))}}static{this.\u0275prov=m({token:r,factory:r.\u0275fac})}}return r})();var Z=new V("");function J(r,t,e,s){return()=>{if(!(O(s)&&"serviceWorker"in navigator&&e.enabled!==!1))return;let i=r.get(B),o=r.get(b);i.runOutsideAngular(()=>{let a=navigator.serviceWorker,p=()=>a.controller?.postMessage({action:"INITIALIZE"});a.addEventListener("controllerchange",p),o.onDestroy(()=>{a.removeEventListener("controllerchange",p)})});let n;if(typeof e.registrationStrategy=="function")n=e.registrationStrategy();else{let[a,...p]=(e.registrationStrategy||"registerWhenStable:30000").split(":");switch(a){case"registerImmediately":n=I(null);break;case"registerWithDelay":n=H(+p[0]||0);break;case"registerWhenStable":let v=M(r.get(b).whenStable());n=p[0]?S(v,H(+p[0])):v;break;default:throw new Error(`Unknown ServiceWorker registration strategy: ${e.registrationStrategy}`)}}i.runOutsideAngular(()=>n.pipe(d(1)).subscribe(()=>navigator.serviceWorker.register(t,{scope:e.scope}).catch(a=>console.error("Service worker registration failed with:",a))))}}function H(r){return I(null).pipe(W(r))}function Q(r,t){return new g(O(t)&&r.enabled!==!1?navigator.serviceWorker:void 0)}var E=class{};function pe(r,t={}){return x([z,C,{provide:Z,useValue:r},{provide:E,useValue:t},{provide:g,useFactory:Q,deps:[E,T]},{provide:K,useFactory:J,deps:[$,Z,E,T],multi:!0}])}var G=class r{constructor(t,e){this.swUpdate=t;this.appRef=e;this.initUpdateCheck(),this.initInstallPrompt()}deferredPrompt;showInstallPrompt=!1;initUpdateCheck(){if(!this.swUpdate.isEnabled){console.log("Service Worker is not enabled");return}let t=this.appRef.isStable.pipe(j(s=>s===!0)),e=F(6*60*60*1e3);t.subscribe(()=>{e.subscribe(()=>{this.swUpdate.checkForUpdate().then(()=>{console.log("Checked for updates")})})}),this.swUpdate.versionUpdates.pipe(l(s=>s.type==="VERSION_READY")).subscribe(()=>{this.promptUserToUpdate()})}initInstallPrompt(){window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.deferredPrompt=t,this.showInstallPrompt=!0,console.log("PWA install prompt available")}),window.addEventListener("appinstalled",()=>{console.log("PWA was installed"),this.showInstallPrompt=!1,this.deferredPrompt=null})}promptUserToUpdate(){confirm("A new version of the app is available. Would you like to update now?")&&this.swUpdate.activateUpdate().then(()=>{document.location.reload()})}installPwa(){return A(this,null,function*(){if(!this.deferredPrompt){console.log("Install prompt is not available");return}this.deferredPrompt.prompt();let{outcome:t}=yield this.deferredPrompt.userChoice;console.log(`User response to install prompt: ${t}`),console.log(t==="accepted"?"User accepted the install prompt":"User dismissed the install prompt"),this.deferredPrompt=null,this.showInstallPrompt=!1})}isInstalled(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://")}checkForUpdate(){this.swUpdate.isEnabled&&this.swUpdate.checkForUpdate().then(t=>{console.log(t?"Update is available":"App is up to date")})}forceUpdate(){this.swUpdate.isEnabled&&this.swUpdate.activateUpdate().then(()=>{document.location.reload()})}static \u0275fac=function(e){return new(e||r)(f(C),f(b))};static \u0275prov=m({token:r,factory:r.\u0275fac,providedIn:"root"})};export{pe as a,G as b};
